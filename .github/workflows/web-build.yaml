name: Build and deploy Secura web

on:
  push:
    tags:
      # Publish on any tag starting with a `v`, e.g., v0.1.0
      - v*
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  # flet-cli version to install for `flet build`
  FLET_CLI_VERSION: 0.28.3

  # Ensures Python uses UTF-8 encoding by default
  PYTHONUTF8: 1

  # Disables rich text formatting in Flet CLI output
  FLET_CLI_NO_RICH_OUTPUT: 1

  # Disables progress bars when using UV
  UV_NO_PROGRESS: 1

jobs:
  build-web:
    name: web build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install the project
        run: uv sync --all-extras --dev

      - name: Install the code linting and formatting tool Ruff
        run: uv tool install ruff
      - name: Lint code with Ruff
        run: uv run ruff check --output-format=github --target-version=py39
        continue-on-error: true
      - name: Check code formatting with Ruff
        run: uv run ruff format --diff --target-version=py39
        continue-on-error: true

      - name: Install flet ${{ env.FLET_CLI_VERSION }}
        run: |
          uv tool install flet[all]

      - name: Flet Build Web
        run: |
          echo "GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}, USER: ${GITHUB_REPOSITORY%/*}, PROJECT_BASE_URL: ${GITHUB_REPOSITORY#*/}"
          flet build web --base-url ${GITHUB_REPOSITORY#*/} --route-url-strategy hash

      - name: Upload Web Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: web-build-artifact
          path: build/web
          if-no-files-found: warn
          overwrite: false

  deploy:
    needs: build-web
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages ðŸš€
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: web-build-artifact
